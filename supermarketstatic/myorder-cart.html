<!DOCTYPE HTML>
<html>
<head>
    <title>订单添加页</title>
    <link href="css/addOrder.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/foot.css"/>
    <link rel="stylesheet" href="css/head.css"/>
    <meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="js/base-v1.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-1.2.6.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/cookie.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/common.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery.cookie.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/jquery-extend.js"></script>
    <script type="text/javascript" src="js/logout.js"></script>
    <script type="text/javascript" src="js/lib-v1.js" charset="utf-8"></script>
    <meta charset="UTF-8">
</head>
<body>
<script type="text/javascript">
    $(function(){
        // alert("好啊1");
        let userId = "";
        let _ticket = $.cookie("EM_TICKET");
        if(!_ticket){
            window.location.href="login.html";
            return ;
        }
        //当dataType类型为jsonp时，jQuery就会自动在请求链接上增加一个callback的参数
        $.ajax({
            url : "http://www.easymall.com/user/query/" + _ticket,
            dataType : "json",
            type : "GET",
            success : function(data){

                if(data.status === 200){
                    let _data = JSON.parse(data.data);//jackson
                    if(_data==null){
                        alert("啥也别说了，你的用户超时了,赶紧查查redis还有数据没有");
                        window.location.href="./login.html";
                        return;}
                    let html = _data.userName + "，欢迎来到京淘！<a href=\"javascript:void(0)\" class=\"link-logout\" onclick='logout()'>[退出]</a>  \|<a href=\"http://www.easymall.com/manage.html\" class=\"link-logout\">[后台]</a>";
                    userId=_data.userId;
                    $("#loginbar").html(html);
                    query(userId);
                }else{
                    alert("咋了兄弟，购物车没东西自己心里没数吗，赶紧购物去");
                }
            },
            error : function(){
                alert('index error.');
            }
        });
    });
    function query(userId){
        $.ajax({
            url:"http://www.easymall.com/cart/query?userId="+userId,
            dataType:"json",
            type:"GET",
            success:function(data){
                if(data.length>0){
                    let money = 0;
                    $.each(data,function(index, cart){
                        let productId = cart.productId;
                        let productName = cart.productName;
                        let productPrice = cart.productPrice;
                        let productImage = cart.productImage;
                        let num = cart.num;
                        let prodHtml = "product-info.html?productId=" + productId;
                        let inputId = "hid_" + productId;
                        let itemMoney = productPrice * num;
                        money=money+itemMoney;
                        $("#myorderTable").append("<tr><input type=\"hidden\" name=\"orderItems["+index+"].productImage\" value=\""+productImage+"\"/><td><img src=\""+productImage+"\" width=\"90\" height=\"90\" /></td><input type=\"hidden\" name=\"orderItems["+index+"].productId\" value=\""+productId+"\"/><td>"+productName+"</td><input type=\"hidden\" name=\"orderItems["+index+"].productName\" value=\""+productName+"\"/><td>"+productPrice+"元</td><input type=\"hidden\" name=\"orderItems["+index+"].productPrice\" value=\""+productPrice+"\"/><td>"+num+"件</td><input type=\"hidden\" name=\"orderItems["+index+"].num\" value=\""+num+"\"/><td>"+itemMoney+"元</td>");
                    })
                    $("#myorderTable").append("<input type=\"hidden\" name=\"orderMoney\" value=\""+money+"\"/>");
                    document.getElementById("total_money").innerText="总价:"+money+"元";
                    $("#myorderTable").append("<input type=\"hidden\" name=\"userId\" value=\""+userId+"\"/>");
                }else{
                    alert("你是不是没登陆啊");
                }
            }
        });
    }
    function submitForm(){
        $.post("/order/save",$("#addOrderForm").serialize(), function(data){
            if(data.status === 200){
                alert("新增订单成功,转向订单查询页面");
                window.location.href="./myorder.html";
            }else if(data.status===201){
                //对不起失败
                alert("新增订单失败,查看失败原因");
            }
        });
    }
    function search(a){
        let query = document.getElementById(a).value;
        //alert(query);
        window.location.href="./search.html?query="+query;
    }
</script>

<div id="common_head">
    <div class="line1">
        <div class="content">
            <ul>
                <li class="fore1" id="loginbar" clstag="homepage|keycount|home2013|01b">
                    <span id="head_span" >
                        <a href="login.html">登录</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                        <a href="regist.html">注册</a>&nbsp;&nbsp;|&nbsp;&nbsp;
                        <a href="manage.html">后台</a>
                    </span>
                </li>
            </ul>
        </div>
    </div>
    <div class="line2">
        <img id="logo" src="img/head/logo.png" alt="logo"/>
        <input type="text" value="" accesskey="s" id="key" autocomplete="off"
               onkeydown="if(event.keyCode===13) search('key');"/>
        <input type="button" value="搜 索" onclick="search('key')"/>
        <span id="goto">
			<a id="goto_order" href="./myorder.html">我的订单</a>
			<a id="goto_cart" href="./mycart.html">我的购物车</a>
		</span>
        <img id="erwm" src="img/head/e2.png" alt="e2" width="76"/>
    </div>
    <div class="line3">
        <div class="content">
            <ul>
                <li><a href="./index.html">首页</a></li>
                <li><a href="./product-list.html?page=1&rows=30">全部商品</a></li>
                <li><a href="./seckill-list.html">秒杀商品</a></li>
                <li><a href="javascript:void(0)">电脑平板</a></li>
                <li><a href="javascript:void(0)">家用电器</a></li>
                <li><a href="javascript:void(0)">汽车用品</a></li>
                <li><a href="javascript:void(0)">食品饮料</a></li>
                <li><a href="javascript:void(0)">图书杂志</a></li>
                <li><a href="javascript:void(0)">服装服饰</a></li>
                <li><a href="javascript:void(0)">大英理财</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="warp">
    <form id="addOrderForm" name="form1" method="post">
        <h3>增加订单</h3>
        <div id="forminfo">
            <span class="lf">收货地址：</span> <label for="textarea"></label>
            <textarea name="orderReceiverinfo" id="textarea" cols="45" rows="5"></textarea>
            <br /> <label for="pay_method">支付方式</label>：<input name="" type="radio" value="" checked="checked" id="pay_method">&nbsp;在线支付
        </div>
        <table id="myorderTable" width="1200" height="80" border="1" cellpadding="0" cellspacing="0" bordercolor="#d8d8d8">
            <tr>
                <th width="276">商品图片</th>
                <th width="247">商品名称</th>
                <th width="231">商品单价</th>
                <th width="214">购买数量</th>
                <th width="232">小计</th>
            </tr>
        </table>
        <div class="Order_price" id="total_money"></div>
        <div class="add_orderbox">
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()"><img src="./img/orderList/addOrder.png" width="120" height="38" alt="addOrder"></a>
        </div>
    </form>
</div>

<div id="common_foot">
    <p>
        Copyright © 2011-2019 网上商城 版权所有 保留一切权利 粤CM-20201119 | 粤ICP备20201119号-1
        <br />
        粤公网安备  20201119号
    </p>
</div>
</body>
</html>